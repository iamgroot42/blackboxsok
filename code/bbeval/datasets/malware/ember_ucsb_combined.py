import os
import numpy as np

from bbeval.datasets.base import CustomDatasetWrapper
from bbeval.config import DatasetConfig
import torch as ch
from torch.utils.data import TensorDataset
from sklearn.model_selection import train_test_split


class EmberAndUCSBWrapper(CustomDatasetWrapper):
    def __init__(self, data_config: DatasetConfig, train_set: str, seed: int):
        """
            self.ds_train and self.ds_test should be set to
            datasets to be used to train and evaluate.
        """
        super().__init__(data_config, num_classes=1)
        # Load data
        full_data_path = os.path.join(self.root, f'{train_set}.npz')
        d = np.load(full_data_path)
        X, y = d['X'], d['y']
        X_train_and_val, X_test, y_train_and_val, y_test = train_test_split(X, y, test_size=0.2,
                                                                            random_state=seed,
                                                                            shuffle=True)

        X_train, X_val, y_train, y_val = train_test_split(X_train_and_val, y_train_and_val, test_size=0.2,
                                                          random_state=seed,
                                                          shuffle=True)

        self.ds_train = TensorDataset(ch.from_numpy(X_train), ch.from_numpy(y_train))
        self.ds_val = TensorDataset(ch.from_numpy(X_val), ch.from_numpy(y_val))
        self.ds_test = TensorDataset(ch.from_numpy(X_test), ch.from_numpy(y_test))


class EmberCombinedWrapper(EmberAndUCSBWrapper):
    def __init__(self, data_config: DatasetConfig):
        """
            self.ds_train and self.ds_test should be set to
            datasets to be used to train and evaluate.
        """
        super().__init__(data_config, train_set="ember", seed=2023)


class UCSBWrapper(EmberAndUCSBWrapper):
    def __init__(self, data_config: DatasetConfig):
        """
            self.ds_train and self.ds_test should be set to
            datasets to be used to train and evaluate.
        """
        super().__init__(data_config, train_set="ucsb", seed=2023)
